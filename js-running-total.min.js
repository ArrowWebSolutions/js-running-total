var Calculations=new function(){this._simple=function(t,i){var e=t.slice(0),s=parseFloat(e.shift().getValue());s=isNaN(s)?0:s;for(var n=0;n<e.length;n++){var a=parseFloat(e[n].getValue());switch(i){case"+":s+=a;break;case"-":s-=a;break;case"*":s*=a;break;case"/":s/=a;break;case"^":s=Math.pow(s,a);break;case"min":s=Math.min(s,a);break;case"max":s=Math.max(s,a)}}return s},this.sum=function(t){return this._simple(t,"+")},this.subtract=function(t){return this._simple(t,"-")},this.multiply=function(t){return this._simple(t,"*")},this.divide=function(t){return this._simple(t,"/")},this.power=function(t){return this._simple(t,"^")},this.pow=function(t){return this.power(t)},this.max=function(t){return this._simple(t,"max")},this.min=function(t){return this._simple(t,"min")}};
function Cell(t){this.listeners=[],this.value=null,this.init(t),this.formatter=null}Cell.prototype.init=function(t){this.setValue(t)},Cell.prototype.setValue=function(t){return this.value=t,this.changed(),this},Cell.prototype.getValue=function(){return this.value},Cell.prototype.addListener=function(t){return this.listeners.push(t),this},Cell.prototype.changed=function(){for(var t=0;t<this.listeners.length;t++)this.listeners[t].targetChanged(this)},Cell.prototype.setFormatter=function(t,e){this.formatter="function"==typeof t?function(n){return t(n,e)}:function(n){return Formatter.format(n,t,e)}},Cell.prototype.getFormattedValue=function(){return this.formatter?this.formatter(this.getValue()):this.getValue()};
var Formatter=new function(){this.defaultOptions={thousandsSeparator:",",decimalPoint:".",precision:0,currencySymbol:"Â£",percentageSymbol:"%"},this.format=function(e,t,n){return"function"==typeof t?t(e,n):this[t](e,n)},this.number=function(e,t){t=this._extend(this.defaultOptions,t);var n=parseFloat(e);if(isNaN(n))return e;var i=this._toFixed(e,t.precision,t.decimalPoint);return this._addSeparators(i,t.thousandsSeparator,t.decimalPoint)},this.currency=function(e,t){"undefined"==typeof t&&(t={}),"undefined"==typeof t.precision&&(t.precision=2);var n=this.number(e,t);return t=this._extend(this.defaultOptions,t),t.currencySymbol+n},this.percentage=function(e,t){"undefined"==typeof t&&(t={}),"undefined"==typeof t.percentageMultiplyer&&(t.percentageMultiplyer=100);var n=parseFloat(e);if(isNaN(n))return e;n*=t.percentageMultiplyer;var i=this.number(n,t);return t=this._extend(this.defaultOptions,t),i+t.percentageSymbol},this._toFixed=function(e,t,n){return"undefined"==typeof n&&(n=this.defaultOptions.decimalPoint),e.toFixed(t).replace(".",n)},this._addSeparators=function(e,t,n){"undefined"==typeof t&&(t=this.defaultOptions.thousandsSeparator),"undefined"==typeof n&&(n=this.defaultOptions.decimalPoint),e+="";for(var i=e.split(n),r=i[0],o=i.length>1?n+i[1]:"",a=/(\d+)(\d{3})/;a.test(r);)r=r.replace(a,"$1"+t+"$2");return r+o},this._extend=function(e,t){if(e&&t){var n={};for(var i in e)n[i]=e[i];for(var i in t)n[i]=t[i];return n}return e}};
function Formula(t,l,n){this.watchedCells=[],this.targetCell=null,this.calculationFunction=null,this.init(t,l,n)}Formula.prototype.init=function(t,l,n){this.targetCell=t,this.watchedCells=l,this.setCalculationFunction(n);for(var i=this,a=0;a<this.watchedCells.length;a++)this.watchedCells[a].addListener(i);this.calculate()},Formula.prototype.setCalculationFunction=function(t){this.calculationFunction="function"==typeof t?function(l){return t(l)}:function(l){return Calculations[t](l)}},Formula.prototype.targetChanged=function(){this.calculate()},Formula.prototype.calculate=function(){var t=this.calculationFunction(this.watchedCells);this.targetCell.setValue(t)};